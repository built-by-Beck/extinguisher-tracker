rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() {
      return request.auth != null;
    }

    function isOwner(ownerId) {
      return signedIn() && ownerId == request.auth.uid;
    }

    // Basic type guards (helps prevent garbage writes)
    function isString(x) { return x is string; }
    function isNullOrString(x) { return x == null || x is string; }
    function isNullOrMap(x) { return x == null || x is map; }
    function isNullOrList(x) { return x == null || x is list; }

    // -------------------------
    // Users
    // -------------------------
    match /users/{userId} {
      // Read: users can read their own document
      allow read: if isOwner(userId);
      
      // Create: users can create their own user document (during signup)
      allow create: if signedIn() && request.auth.uid == userId;
      
      // Update/Delete: users can update/delete their own document
      allow update, delete: if isOwner(userId);
    }

    // -------------------------
    // Workspaces
    // -------------------------
    match /workspaces/{workspaceId} {
      allow read: if signedIn() &&
        (resource == null || resource.data.userId == request.auth.uid);
      allow create: if signedIn() &&
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if signedIn() &&
        resource.data.userId == request.auth.uid
        && request.resource.data.userId == resource.data.userId;
    }

    // -------------------------
    // Buildings (top-level)
    // -------------------------
    match /buildings/{buildingId} {
      // Read: only the owner can read/list their own buildings
      allow get, list: if signedIn() && 
        (resource == null || resource.data.userId == request.auth.uid);

      // Create: user can create a building only for themselves
      allow create: if signedIn()
        && request.resource.data.userId == request.auth.uid
        && isString(request.resource.data.name);

      // Update/Delete: only owner + prevent userId hijacking
      allow update, delete: if signedIn()
        && resource.data.userId == request.auth.uid
        && request.resource.data.userId == resource.data.userId;

      // --------------------------------------------
      // Extinguishers as a subcollection of a building
      // --------------------------------------------
      match /extinguishers/{extinguisherId} {
        function buildingDoc() {
          return get(/databases/$(database)/documents/buildings/$(buildingId));
        }

        function buildingOwnerId() {
          return buildingDoc().data.userId;
        }

        // Read: only building owner
        allow get, list: if signedIn()
          && buildingDoc() != null
          && buildingOwnerId() == request.auth.uid;

        // Create: only building owner, and extinguisher must "belong" to that building
        allow create: if signedIn()
          && buildingDoc() != null
          && buildingOwnerId() == request.auth.uid
          && request.resource.data.userId == request.auth.uid
          && request.resource.data.buildingId == buildingId

          // --- minimal field validation (optional but recommended) ---
          && isNullOrString(request.resource.data.assetId)
          && isNullOrString(request.resource.data.serial)
          && isNullOrString(request.resource.data.location)
          && isNullOrString(request.resource.data.vicinity)
          && isNullOrString(request.resource.data.parentLocation)
          && isNullOrString(request.resource.data.section)
          && isNullOrString(request.resource.data.status)
          && isNullOrString(request.resource.data.manufactureYear)
          && isNullOrString(request.resource.data.checkedDate)
          && isNullOrString(request.resource.data.createdAt)
          && isNullOrString(request.resource.data.updatedAt)
          && isNullOrString(request.resource.data.importedAt)
          && isNullOrString(request.resource.data.importedFrom)
          && isNullOrString(request.resource.data.workspaceId)
          && isNullOrString(request.resource.data.notes)
          && isNullOrString(request.resource.data.photoUrl)
          && isNullOrString(request.resource.data.lastInspectionPhotoUrl)
          && isNullOrString(request.resource.data.lastMonthlyReset)
          && isNullOrMap(request.resource.data.gps)
          && isNullOrMap(request.resource.data.location)
          && isNullOrMap(request.resource.data.lastInspectionGps)
          && isNullOrList(request.resource.data.inspectionHistory)
          && isNullOrList(request.resource.data.photos)
          && isNullOrMap(request.resource.data.checklistData);

        // Update/Delete: only building owner + prevent moving it to another building + prevent ownerId swap
        allow update, delete: if signedIn()
          && buildingDoc() != null
          && buildingOwnerId() == request.auth.uid
          && resource.data.userId == request.auth.uid
          && request.resource.data.userId == resource.data.userId
          && request.resource.data.buildingId == resource.data.buildingId;
      }
    }

    // -------------------------
    // Section Notes
    // -------------------------
    match /sectionNotes/{noteId} {
      allow read: if signedIn() &&
        (resource == null || resource.data.userId == request.auth.uid);
      allow create: if signedIn() &&
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if signedIn() &&
        resource.data.userId == request.auth.uid
        && request.resource.data.userId == resource.data.userId;
    }

    // -------------------------
    // Inspection Logs
    // -------------------------
    match /inspectionLogs/{logId} {
      allow read, write: if signedIn();
    }

    // -------------------------
    // Stripe Extension Collections
    // -------------------------
    match /customers/{uid} {
      allow read: if request.auth.uid == uid;

      match /checkout_sessions/{id} {
        allow read, write: if request.auth.uid == uid;
      }
      match /subscriptions/{id} {
        allow read: if request.auth.uid == uid;
      }
      match /payments/{id} {
        allow read: if request.auth.uid == uid;
      }
    }

    match /products/{id} {
      allow read: if true;

      match /prices/{id} {
        allow read: if true;
      }

      match /tax_rates/{id} {
        allow read: if true;
      }
    }
  }
}
